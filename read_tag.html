<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style media="screen">
      @font-face {
        font-family: SourceSansVariable;
        font-weight: 100 800;
        src: url(_fonts/SourceSans3VF-Roman.ttf.woff2) format("woff2");
      }
      * { margin:0; padding: 0; }
      html { font-size: 100%; /* 1rem = 1em = 16px */}
      body {
        line-height: 120%;
        /* deco */
        background-color: #f0f0f0;
        color: #333;
        font-family: SourceSansVariable;
        font-weight: 100;
      }
    aside {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #333;
      height: 3rem;
      width: 50vw;
      position: fixed;
      bottom: 0;
      left: 0;
      font-size: 1rem;
      color: #eee;
    }
    article {
      display: flex;
      margin: 1rem;
    }
    article select {
      margin: 0 1rem 0 .5rem;
    }
    .output {
      margin: 1rem;
      border: 1px dotted gray;
      height: calc(100vh - 8rem);
      overflow-y: scroll;
    }
    </style>

  </head>
  <body>
    <!-- commentaire  -->
    <p class="output" id="outputIn"></p>
  <aside>commentaire</aside>
    <script>
      // https://webmidi-examples.glitch.me/
      // Globals to access them later.
      let midiIn = [];
      let midiOut = [];
      let midi = [];
      let init = false;
      let boitier = {in:0,out:0};
      connect();

      // Start up WebMidi.
      function connect() {
        navigator.requestMIDIAccess()
        .then(
          (midi) => {
            midi.addEventListener('statechange', (event) => initBoitier(event.target, false));
            initBoitier(midi);
          },
          (err) => {
            outputIn.innerHTML = 'Il y a un pb avec le midi';
            console.log('Something went wrong', err)
          });
      }

      function initBoitier(midi, bool) {
        // Reset.
        midiIn = [];
        midiOut = [];
        if (bool) {
          init = bool;
        }

        // MIDI devices that send you data.
        const inputs = midi.inputs.values();
        for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
          midiIn.push(input.value);
        }

        // MIDI devices that you send data to.
        const outputs = midi.outputs.values();
        for (let output = outputs.next(); output && !output.done; output = outputs.next()) {
          midiOut.push(output.value);
        }
        if (!init) { // declaration unique
          midiIn.map(device => {
            if (/usb_midi|Herve/.test(device.name)) {
              // deviceIn = device;
              boitier.in = device;
              console.log(boitier.in.name," trouvé");
            }
          })
          midiOut.map(device => {
            if (/usb_midi|Herve/.test(device.name)) {
              // deviceOut = device;
              boitier.out = device;
              console.log(boitier.out.name," trouvé");
            }
          })
          // initialise le champ texte
          outputIn.innerHTML = (boitier.in) ?"<strong>boitier détecté : placez un tag sur le lecteur</strong><br>":"<strong>boitier introuvable</strong><br>";
          // place l'écouteur sur l'entrée midi du boitier
          boitier.in.addEventListener('midimessage', midiMessageReceived);
          //
          //initialise les valeurs du boitier
          boitier.out.send([0x80, 64, 127],100);
          // passe le boolean à vrai ne réinitialise pas
          init = true;
        }
      }

      const tag = [];
      function midiMessageReceived(event) {
        if (midi[event.data[1]] != null) {
          port = event.data[1];
          valeur = event.data[2];
          switch(port) {
            case 7:
              tag[Math.floor(port/2)] += valeur;
              outputIn.innerHTML += `uuid : <strong>${tag[0].toString(16)} ${tag[1].toString(16)} ${tag[2].toString(16)} ${tag[3].toString(16)}</strong><br>`;
              break;
            default:
              //println(number,value,hex(value),"générique");
              if (port%2 == 0) { // debut de chiffre
                tag[Math.floor(port/2)] = valeur*128;
              } else {
                tag[Math.floor(port/2)] += valeur;
                console.log(`${tag[Math.floor(port/2)].toString(16)}`)
              }
          }
          // Scroll to the bottom of this div.
          outputIn.scrollTop = outputIn.scrollHeight;
        } else {
          midi[event.data[1]] = {port:0,valeur:0};
        }
      }
    </script>
  </body>
</html>
